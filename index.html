<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex,nofollow">
<title>üéüÔ∏è Rifa Solidadria ‚Äì Sorteo iPhone 13 Pro Max 256 GB</title>
<style>
  :root{
    --bg1:#fff1f2; --bg2:#ffe4e6; --card:#fff7fb; --border:#fbcfe8;
    --text:#3f0a1a; --muted:#9f1239; --accent:#ec4899; --accent2:#f472b6;
    --chip:#ffe4e6; --sold:#f5e7ee; --sel:#831843;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
       background:linear-gradient(120deg,var(--bg1),var(--bg2));color:var(--text)}
  .wrap{max-width:1100px;margin:28px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
        padding:18px;box-shadow:0 10px 30px rgba(190,24,93,.10)}
  .hero{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
  h1{margin:0 0 6px;font-size:clamp(1.6rem,3.2vw,2.2rem)}
  .sub{color:var(--muted);font-weight:600}
  .pills{margin-top:6px}
  .pills span{display:inline-block;border:1px solid var(--border);color:var(--accent);
              background:var(--chip);border-radius:999px;padding:6px 12px;margin-right:8px;font-weight:800}
  .status{font-size:.9rem;color:#9f1239;margin-top:6px}

  /* Etiquetas */
  .label{display:inline-block;padding:6px 10px;border-radius:10px;font-weight:800}
  .label.dark{background:var(--sel);color:#fff}

  /* Leyenda + grid */
  .legend{display:flex;gap:14px;align-items:center;color:#9f1239;font-size:.95rem;flex-wrap:wrap}
  .legend .chip{width:14px;height:14px;border-radius:4px;display:inline-block;background:#fff;border:1px solid var(--border)}
  .legend .sel{background:#fce7f3;border-color:var(--accent)}
  .legend .sold{background:var(--sold)}

  .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:12px;margin-top:10px}
  .num{display:flex;align-items:center;justify-content:center;
       padding:12px 6px;border-radius:12px;border:1px solid var(--border);
       background:#fff;color:var(--text);font-weight:800;user-select:none;cursor:pointer;
       transition:.1s ease;box-shadow:0 2px 0 rgba(0,0,0,.04);
       font-size:clamp(14px,3.7vw,18px);line-height:1;letter-spacing:.5px}
  .num:hover{transform:translateY(-1px);border-color:var(--accent2)}
  .num.sel{background:var(--sel);color:#fff;border-color:var(--sel);box-shadow:0 0 0 2px rgba(131,24,67,.15) inset}
  .num.sold{background:var(--sold);color:#a1a1aa;text-decoration:line-through;cursor:not-allowed}
  .num:active{transform:scale(.98)}
  .num:focus-visible{outline:2px solid #ec4899;outline-offset:2px}

  .sum{margin-top:8px;font-weight:800;color:#6b021b}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{all:unset;cursor:pointer;padding:10px 14px;border-radius:10px;font-weight:800;
       border:1px solid var(--border);background:linear-gradient(180deg,#fdf2f8,#fce7f3);
       color:#831843;box-shadow:0 1px 0 rgba(0,0,0,.04)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .btn.secondary{background:#fff}

  /* Contacto */
  .pay{display:grid;grid-template-columns:1fr auto;gap:18px;align-items:start}
  .pay ul{margin:8px 0 0 0;padding-left:0;list-style:none}
  .pay li{margin:4px 0}
  .qr img{width:160px;height:160px;border-radius:12px;border:1px solid var(--border);background:#fff;display:block}

  /* Responsive */
  @media (max-width:900px){ .grid{grid-template-columns:repeat(8,1fr)} }
  @media (max-width:640px){
    .grid{grid-template-columns:repeat(6,1fr)}
    .num{padding:12px 4px}
    .pay{grid-template-columns:1fr}
  }
  @media (max-width:420px){
    .grid{grid-template-columns:repeat(5,1fr)}
    .num{padding:12px 2px;font-size:clamp(13px,4vw,17px)}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Cabecera -->
  <div class="card hero">
    <div>
      <h1>üéüÔ∏è Rifa Solidaria ‚Äì Sorteo iPhone 13 Pro Max 256 GB</h1>
      <div class="sub">Eleg√≠ hasta <b>3</b> n√∫meros y escribime por WhatsApp üí¨</div>
      <div class="pills"><span>1 √ó $10.000</span><span>2 √ó $18.000</span><span>3 √ó $26.000</span></div>
      <div id="st" class="status">Estado: conectando‚Ä¶</div>
    </div>
  </div>

  <!-- Selecci√≥n -->
  <div class="card" style="margin-top:12px;">
    <div class="label dark">Selecci√≥n de n√∫meros</div>
    <div class="legend" style="margin-top:10px">
      <span class="chip"></span> Disponible
      <span class="chip sel"></span> Seleccionado
      <span class="chip sold"></span> Reservado/PAGO
    </div>

    <div id="grid" class="grid"></div>

    <div id="summary" class="sum">Seleccionados: ‚Äî</div>
    <div class="actions">
      <span class="label dark" style="align-self:center">Confirmaci√≥n por WhatsApp</span>
      <button id="confirm" class="btn" disabled>Confirmar por WhatsApp</button>
      <button id="clear" class="btn secondary">Limpiar selecci√≥n n√∫meros</button>
    </div>
  </div>

  <!-- Bases -->
  <div class="card" style="margin-top:12px;">
    <h3>üìù Bases & Condiciones</h3>
    <p>‚Ä¢ <b>C√≥mo participar:</b> Eleg√≠s n√∫mero(s) disponible(s), confirmas por WhatsApp, pag√°s y envi√°s comprobante.</p>
    <p>‚Ä¢ <b>Confirmaci√≥n:</b> El/los n√∫mero(s) quedan ‚ÄúPAGO‚Äù. Si solo reserv√°s, la reserva dura 15 MINUTOS.</p>
    <p>‚Ä¢ <b>Sorteo:</b> Cuando se vendan los 200 n√∫meros (se fija fecha tope).</p>
    <p>‚Ä¢ <b>Modalidad de sorteo:</b> <b>Quiniela Nocturna de la Ciudad (CABA), √∫ltimas 3 cifras del 1.¬∫ premio.</b></p>
    <p>‚Ä¢ <b>Transparencia:</b> Se publica el listado final, el comprobante del sorteo y la persona ganador/a.</p>
    <p>‚Ä¢ <b>Entrega:</b> <i> En mano en Palmas del Pilar, Tortugas Open Mall, El Solar Shopping o env√≠o a cargo del/la ganador/a.</i></p>
    <p>‚Ä¢ <b>Devoluciones:</b> No aplica una vez acreditado el pago.</p>
  </div>

  <!-- Contacto + Medios de pago + QR -->
  <div class="card" style="margin-top:12px;">
    <h3>üì¨ Contacto & Medios de pago</h3>
    <div class="pay">
      <div>
        <p><b>Instagram:</b> <a href="https://instagram.com/mariangelaramirezz" target="_blank" rel="noopener">@mariangelaramirezz</a></p>
        <ul>
          <li><b>Medio de pago √∫nico:</b> Transferencia</li>
          <li><b>Cuenta de Mercado Pago</b></li>
          <li><b>Titular:</b> Francesca Lisanti</li>
          <li><b>Alias:</b> cukirescatados</li>
          <li><b>CVU:</b> 0000003100061623575458</li>
        </ul>
      </div>
      <div class="qr">
        <img alt="QR WhatsApp 5491133328404"
             src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https%3A%2F%2Fwa.me%2F5491133328404">
        <div style="margin-top:8px">
          <a class="btn" href="https://wa.me/5491133328404" target="_blank" rel="noopener">Abrir WhatsApp</a>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbxi44XsIbWigyuZ8wWLgp0ESwEV9GcasR3179_YtXuWu7SWf7uKBjdElsc6s5KBHB2MBg/exec"; // <-- peg√° ac√° tu /exec
const WHATS     = "5491133328404";
const MAX_SELECT= 3;                   // pon√© 4 si quer√©s permitir 4
const PRICES    = {1:10000,2:18000,3:26000};
const ALIAS     = "cukirescatados";
const CVU       = "0000003100061623575458";

/* ============ Helpers/UI ============ */
const grid   = document.getElementById('grid');
const summary= document.getElementById('summary');
const btnOk  = document.getElementById('confirm');
const btnClr = document.getElementById('clear');
const st     = document.getElementById('st');

let selected = new Set();
let taken    = new Set();

const clientId = (() => {
  const k='raffleClientId';
  let v = localStorage.getItem(k);
  if(!v){ v=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random()); localStorage.setItem(k,v); }
  return v;
})();

function fmt(n){ return n.toString().padStart(3,'0'); }
function pesos(n){ return n.toLocaleString('es-AR'); }

function bestPrice(k){
  const tiers=Object.keys(PRICES).map(Number).sort((a,b)=>a-b);
  const dp=Array(k+1).fill(Infinity); dp[0]=0;
  for(let i=1;i<=k;i++) for(const t of tiers) if(t<=i) dp[i]=Math.min(dp[i],dp[i-t]+PRICES[t]);
  return dp[k] || 0;
}

function updateSummary(){
  const arr=[...selected].sort((a,b)=>a-b).map(fmt);
  const k=arr.length, total=bestPrice(k);
  summary.textContent = k ? `Seleccionados: ${arr.join(', ')} ‚Ä¢ Total a pagar: $${pesos(total)}` : 'Seleccionados: ‚Äî';
  btnOk.disabled = (k===0);
}

/* ============ API ============ */
function buildUrl(params){
  const q=new URLSearchParams(params).toString();
  const join=API_BASE.includes('?')?'&':'?';
  return API_BASE + (q? join+q : '');
}
async function apiGet(params){
  const r = await fetch(buildUrl(params), {cache:'no-store'});
  if(!r.ok) throw new Error('GET '+r.status);
  return r.json();
}
async function apiPost(params){
  const r = await fetch(API_BASE, {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},
               body:new URLSearchParams(params)});
  if(!r.ok) throw new Error('POST '+r.status);
  return r.json();
}

/* ============ Render r√°pido ============ */
function makeCell(i){
  const d=document.createElement('div');
  d.className='num'; d.tabIndex=0; d.textContent=fmt(i);
  d.addEventListener('click', ()=>toggle(i,d));
  d.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(i,d); }});
  return d;
}
function renderGridQuick(){
  const frag=document.createDocumentFragment();
  for(let i=1;i<=200;i++) frag.appendChild(makeCell(i));
  grid.innerHTML=''; grid.appendChild(frag);
}
function repaintSelections(){
  document.querySelectorAll('.num.sel').forEach(el=>el.classList.remove('sel'));
  for(const n of selected){
    const el=grid.children[n-1];
    if(el && !el.classList.contains('sold')) el.classList.add('sel');
  }
}

/* ============ Interacci√≥n ============ */
async function toggle(n, el){
  if(el.classList.contains('sold')) return;

  if(selected.has(n)){
    selected.delete(n); el.classList.remove('sel'); updateSummary();
    try{ await apiPost({action:'release', clientId, ns:String(n)});}catch(_){}
    return;
  }
  if(selected.size>=MAX_SELECT) return;

  // Optimista: marca r√°pido
  selected.add(n); el.classList.add('sel'); updateSummary();

  try{
    const res=await apiPost({action:'hold', clientId, ns:String(n)});
    if(!(res.ok && res.ok.includes(n))){
      // no se pudo ‚Üí revierte
      selected.delete(n); el.classList.remove('sel');
      taken.add(n); el.classList.add('sold');
      updateSummary();
    }
  }catch(_){
    // si falla red, dejamos seleccionado para que pueda confirmar igual
    st.textContent='Estado: conexi√≥n inestable';
  }
}

function waLink(){
  const arr=[...selected].sort((a,b)=>a-b).map(fmt);
  const total=bestPrice(arr.length);
  const msg=`Hola Mar!
Quiero participar con el n√∫mero(s): ${arr.join(', ')}.
Total a pagar: $${pesos(total)}.

Alias: ${ALIAS}
CVU: ${CVU}

Te env√≠o el comprobante ahora.`;
  return "https://wa.me/"+WHATS+"?text="+encodeURIComponent(msg);
}

btnOk.addEventListener('click', async ()=>{
  if(selected.size===0) return;
  const ns=[...selected].join(',');
  const link=waLink();
  btnOk.disabled=true; st.textContent='Confirmando‚Ä¶';

  const t=setTimeout(()=>{ window.location.href=link; },1200); // fallback r√°pido
  try{
    const res=await apiPost({action:'finalize', clientId, ns});
    clearTimeout(t);
    if(res.lost && res.lost.length){
      for(const n of res.lost){ taken.add(Number(n)); selected.delete(Number(n)); }
      // pintar vendidos
      res.lost.forEach(n=>{
        const el=grid.children[n-1]; if(el){ el.classList.remove('sel'); el.classList.add('sold'); }
      });
      updateSummary(); st.textContent='Algunos n√∫meros se agotaron. Eleg√≠ otros.'; btnOk.disabled=false; return;
    }
    window.location.href=link;
  }catch(_){ window.location.href=link; }
});

btnClr.addEventListener('click', async ()=>{
  const ns=[...selected].join(',');
  selected.clear(); repaintSelections(); updateSummary();
  if(ns){ try{ await apiPost({action:'release', clientId, ns}); }catch(_){} }
});

/* ============ Estado ============ */
async function loadState(){
  try{
    const res=await apiGet({action:'state'});
    taken=new Set([...(res.sold||[]), ...(res.reserved||[])]);
    // pintar vendidos
    taken.forEach(n=>{
      const el=grid.children[n-1]; if(el){ el.classList.add('sold'); el.classList.remove('sel'); }
    });
    st.textContent='Estado: conectado ‚úì';
  }catch(_){ st.textContent='Estado: sin conexi√≥n'; }
}

/* Boot */
renderGridQuick();     // pinta YA los 200 n√∫meros
updateSummary();
loadState();           // trae vendidos
setInterval(loadState,15000);
</script>
</body>
</html>


